<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dummy AI Worker Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #0d1117; /* Dark charcoal background */
            color: #c9d1d9; /* Light grey text */
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #161b22; /* Slightly lighter container background */
            border: 1px solid #30363d;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        h1, h2 {
            color: #58a6ff; /* A bright, friendly blue for headers */
            border-bottom: 2px solid #388bfd; /* A slightly darker blue for the underline */
            padding-bottom: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2em;
            text-align: center;
            background: -webkit-linear-gradient(#388bfd, #58a6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 { font-size: 1.6em; }
        h3 { font-size: 1.2em; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .stat-item {
            background-color: #0d1117; /* Back to the darkest background for contrast */
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #30363d;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .stat-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        .stat-item h3 {
            margin-top: 0;
            color: #c9d1d9;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-item p {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0 0 0;
            color: #3FB950; /* The prominent GitHub-like green for success/values */
        }
        #recent_chunks_list {
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            background-color: #010409; /* Even darker for the log list */
        }
        #recent_chunks_list li {
            background-color: #161b22;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 4px;
            font-size: 0.9em;
            border-left: 4px solid #3FB950; /* Green accent for success */
            transition: background-color 0.2s;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }
        #recent_chunks_list li:hover {
            background-color: #21262d;
        }
        #recent_chunks_list li.violence {
            border-left-color: #F85149; /* Red accent for violence */
        }
        #recent_chunks_list li.violence strong {
            color: #F85149;
        }
        #recent_chunks_list li span {
            flex-basis: 50%;
            padding: 2px 0;
        }
        #recent_chunks_list li strong { color: #58a6ff; }
        #recent_chunks_list li small { color: #8b949e; display: block; margin-top: 5px; flex-basis: 100%;}
        
        .info-icon-container {
            display: inline-block;
            position: relative;
            cursor: help;
        }
        .info-icon {
            font-size: 0.8em;
            color: #8b949e;
            border: 1px solid #30363d;
            border-radius: 50%;
            padding: 2px 6px;
            margin-left: 8px;
        }
        .tooltip-text {
            visibility: hidden;
            width: 260px;
            background-color: #21262d;
            color: #c9d1d9;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 135%; 
            left: 50%;
            margin-left: -130px; 
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 0.9em;
            font-weight: normal;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1px solid #30363d;
        }
        .info-icon-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .chart-container {
            padding: 15px;
            background-color: #161b22; /* Match the container background */
            border-radius: 6px;
            margin-top: 15px;
            height: 280px;
            border: 1px solid #30363d;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #0d1117;
        }
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Dummy AI Worker - Live Stats</h1>

        <h2>Overall Status</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <h3>
                    <span>RabbitMQ Status</span>
                    <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">Current connection status to the RabbitMQ server and the queue this worker is listening to. Green text indicates active connection.</span>
                    </span>
                </h3>
                <p id="rabbitmq_status">N/A</p>
            </div>
            <div class="stat-item">
                <h3>
                    <span>MinIO Status</span>
                    <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">Current connection status to the MinIO object storage server. Green text indicates active connection.</span>
                    </span>
                </h3>
                <p id="minio_status">N/A</p>
            </div>
            <div class="stat-item">
                <h3>
                    <span>Total Messages Processed</span>
                    <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">Total number of messages (chunks) successfully processed by this worker instance since it started.</span>
                    </span>
                </h3>
                <p id="total_messages_processed">0</p>
            </div>
            <div class="stat-item">
                <h3>
                    <span>Last Message Received At</span>
                     <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">Timestamp (UTC) of the last message successfully received from RabbitMQ. Updates with each new message.</span>
                    </span>
                </h3>
                <p id="last_message_received_at">N/A</p>
            </div>
        </div>

        <h2>Graphs</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <h3>RabbitMQ - Message Rates (msgs/sec)
                    <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">A line graph showing the rate of messages being published to the queue versus the rate they are acknowledged by the worker. Helps identify bottlenecks.</span>
                    </span>
                </h3>
                <div class="chart-container">
                    <canvas id="rabbitmqChart"></canvas>
                </div>
            </div>
            <div class="stat-item">
                <h3>MinIO - Download Times (Last <span id="minio_chart_points_display">N</span> chunks)
                    <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">A bar chart representing the time taken (in seconds) to download each of the most recent chunks from MinIO. Useful for spotting download bottlenecks.</span>
                    </span>
                </h3>
                <div class="chart-container">
                    <canvas id="minioChart"></canvas>
                </div>
            </div>
            <div class="stat-item">
                <h3>Worker - Total Processing Time (Last <span id="worker_chart_points_display">N</span> chunks)
                    <span class="info-icon-container">
                        <span class="info-icon">&#9432;</span>
                        <span class="tooltip-text">A bar chart showing the total time spent by the worker for each of the most recent chunks. This includes download, simulated AI processing, and any overhead.</span>
                    </span>
                </h3>
                <div class="chart-container">
                    <canvas id="workerChart"></canvas>
                </div>
            </div>
        </div>

        <h2>Recent Chunk Processing (Last <span id="max_recent_stats_display">N</span>)
            <span class="info-icon-container">
                <span class="info-icon">&#9432;</span>
                <span class="tooltip-text">A list of the latest chunks processed, showing key metrics for each. Newest entries appear at the top. The list is scrollable.</span>
            </span>
        </h2>
        <ul id="recent_chunks_list">
            <!-- Stats will be populated here -->
        </ul>
    </div>

    <script>
        let rabbitmqChartInstance, minioChartInstance, workerChartInstance;
        const MAX_CHART_POINTS = 20; // Max data points to show on time-series charts
        const CHART_TEXT_COLOR = '#E0E0E0'; // Light color for chart text, labels, ticks

        function initCharts() {
            const genericOptions = {
                responsive: true,
                maintainAspectRatio: false, // Important for fixed height container
                scales: {
                    x: { 
                        ticks: { autoSkip: true, maxTicksLimit: 10, color: CHART_TEXT_COLOR },
                        grid: { color: 'rgba(224, 224, 224, 0.1)' } // Lighter grid lines
                    },
                    y: { 
                        beginAtZero: true,
                        ticks: { color: CHART_TEXT_COLOR },
                        grid: { color: 'rgba(224, 224, 224, 0.1)' } // Lighter grid lines
                    }
                },
                elements: { line: { tension: 0.1 } },
                plugins: {
                    legend: { labels: { color: CHART_TEXT_COLOR } }
                }
            };

            const rabbitmqCtx = document.getElementById('rabbitmqChart').getContext('2d');
            rabbitmqChartInstance = new Chart(rabbitmqCtx, {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [
                        { 
                            label: 'Publish Rate (msgs/sec)', 
                            data: [], 
                            borderColor: '#36A2EB', // Blue
                            backgroundColor: 'rgba(54, 162, 235, 0.2)', 
                            borderWidth: 1.5, 
                            pointBackgroundColor: '#36A2EB', 
                            pointRadius: 2  
                        },
                        { 
                            label: 'Acknowledge Rate (msgs/sec)', 
                            data: [], 
                            borderColor: '#4CAF50', // Green
                            backgroundColor: 'rgba(75, 175, 80, 0.2)', 
                            borderWidth: 1.5, 
                            pointBackgroundColor: '#4CAF50', 
                            pointRadius: 2  
                        }
                    ] 
                },
                options: {
                    ...genericOptions, // Spread generic options first
                    scales: {
                        ...genericOptions.scales, // Spread generic scales
                        y: {
                            ...genericOptions.scales.y, // Spread generic y-axis options
                            suggestedMax: 1.0 // Suggest a max of 1.0 for the y-axis
                        }
                    },
                    elements: {
                        ...genericOptions.elements,
                        line: {
                            ...genericOptions.elements.line,
                            tension: 0.1 // Increase line tension for smoother curves
                        }
                    },
                    plugins: { 
                        ...genericOptions.plugins, 
                        title: { display: false, text: 'RabbitMQ Message Rates', color: CHART_TEXT_COLOR }
                    }
                }
            });

            const minioCtx = document.getElementById('minioChart').getContext('2d');
            minioChartInstance = new Chart(minioCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Download Duration (s)', data: [], borderColor: '#36A2EB', backgroundColor: 'rgba(54, 162, 235, 0.2)', borderWidth: 1.5 }] },
                options: {...genericOptions, plugins: { ...genericOptions.plugins, title: { display: false, text: 'MinIO Download Times', color: CHART_TEXT_COLOR }}}
            });
            document.getElementById('minio_chart_points_display').textContent = MAX_CHART_POINTS;

            const workerCtx = document.getElementById('workerChart').getContext('2d');
            workerChartInstance = new Chart(workerCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Total Worker Time (s)', data: [], borderColor: '#4BC0C0', backgroundColor: 'rgba(75, 192, 192, 0.2)', borderWidth: 1.5 }] },
                options: {...genericOptions, plugins: { ...genericOptions.plugins, title: { display: false, text: 'Worker Processing Times', color: CHART_TEXT_COLOR }}}
            });
            document.getElementById('worker_chart_points_display').textContent = MAX_CHART_POINTS;
        }

        let timestamps = []; // For RabbitMQ chart x-axis - can be used if needed for more precise time

        function updateCharts(statsData) {
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // RabbitMQ Chart (Publish vs Acknowledge Rates)
            if (rabbitmqChartInstance) {
                rabbitmqChartInstance.data.labels.push(now);
                rabbitmqChartInstance.data.datasets[0].data.push(statsData.rabbitmq_publish_rate || 0); // Publish Rate
                rabbitmqChartInstance.data.datasets[1].data.push(statsData.rabbitmq_ack_rate || 0);   // Acknowledge Rate
                
                if (rabbitmqChartInstance.data.labels.length > MAX_CHART_POINTS) {
                    rabbitmqChartInstance.data.labels.shift();
                    rabbitmqChartInstance.data.datasets[0].data.shift();
                    rabbitmqChartInstance.data.datasets[1].data.shift();
                }
                rabbitmqChartInstance.update('none'); // 'none' for no animation, smoother updates
            }

            // MinIO Chart & Worker Chart (from recent_chunk_stats)
            if (minioChartInstance && workerChartInstance && statsData.recent_chunk_stats) {
                const recentChunks = statsData.recent_chunk_stats.slice(-MAX_CHART_POINTS); 
                
                // Shorten labels for charts, using timestamp as a simple unique ID for the x-axis
                const chartLabels = recentChunks.map(chunk => new Date(chunk.received_at * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }));
                
                const minioDownloadData = recentChunks.map(chunk => chunk.download_duration_s);
                minioChartInstance.data.labels = chartLabels;
                minioChartInstance.data.datasets[0].data = minioDownloadData;
                minioChartInstance.update('none');

                const workerTotalTimeData = recentChunks.map(chunk => chunk.total_worker_time_s);
                workerChartInstance.data.labels = chartLabels; 
                workerChartInstance.data.datasets[0].data = workerTotalTimeData;
                workerChartInstance.update('none');
            }
        }

        function fetchStats() {
            fetch('/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('rabbitmq_status').textContent = data.rabbitmq_status || 'N/A';
                    document.getElementById('minio_status').textContent = data.minio_status || 'N/A';
                    
                    // Style status based on content
                    if(data.rabbitmq_status && data.rabbitmq_status.toLowerCase().includes("connected")){
                        document.getElementById('rabbitmq_status').style.color = '#4CAF50'; // Green for connected
                    } else {
                        document.getElementById('rabbitmq_status').style.color = '#FFB300'; // Amber for other states
                    }
                    if(data.minio_status && data.minio_status.toLowerCase().includes("connected")){
                        document.getElementById('minio_status').style.color = '#4CAF50';
                    } else {
                        document.getElementById('minio_status').style.color = '#FFB300';
                    }

                    document.getElementById('total_messages_processed').textContent = data.total_messages_processed || 0;
                    document.getElementById('last_message_received_at').textContent = data.last_message_received_at ? new Date(data.last_message_received_at).toLocaleString() : 'N/A';
                    
                    const statsList = document.getElementById('recent_chunks_list');
                    statsList.innerHTML = ''; 

                    if (data.recent_chunk_stats && data.recent_chunk_stats.length > 0) {
                        const numToDisplayInList = data.recent_chunk_stats.length;
                        document.getElementById('max_recent_stats_display').textContent = numToDisplayInList > MAX_CHART_POINTS ? `${MAX_CHART_POINTS} (showing ${numToDisplayInList} in list)` : numToDisplayInList;
                        
                        const displayChunks = data.recent_chunk_stats.slice(-(data.max_recent_stats || 50)); // Show up to 50 in list
                        displayChunks.reverse().forEach(chunk => {
                            const listItem = document.createElement('li');
                            const chunkName = chunk.chunk_url.split('/').pop();
                            let aiResultDisplay = '';
                            if (chunk.ai_simulation_result) {
                                const resultColor = chunk.ai_simulation_result === 'violence' ? '#F44336' : '#4CAF50'; // Red for violence, Green for no_violence
                                aiResultDisplay = `<br><strong>AI Result:</strong> <span style="color: ${resultColor};">${chunk.ai_simulation_result}</span>`;
                            }

                            listItem.innerHTML = `
                                <strong>Chunk:</strong> <span title="${chunk.chunk_url}">${chunkName}</span> <br>
                                <small>
                                <strong>Received:</strong> ${new Date(chunk.received_at * 1000).toLocaleString()} | 
                                <strong>Download:</strong> ${chunk.download_duration_s}s | 
                                <strong>AI Sim:</strong> ${chunk.simulated_processing_s}s | 
                                <strong>Total Worker:</strong> ${chunk.total_worker_time_s}s
                                ${aiResultDisplay}
                                </small>
                            `;
                            statsList.appendChild(listItem);
                        });
                    } else {
                        document.getElementById('max_recent_stats_display').textContent = '0';
                        statsList.innerHTML = '<li>No recent chunk data.</li>';
                    }

                    updateCharts(data);
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                    const statusElements = ['rabbitmq_status', 'minio_status', 'total_messages_processed', 'last_message_received_at'];
                    statusElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = 'Error loading stats';
                        if (el) el.style.color = '#F44336'; // Red for error
                    });
                });
        }

        window.onload = () => {
            initCharts();
            fetchStats(); 
            setInterval(fetchStats, 5000);
        };
    </script>
</body>
</html>